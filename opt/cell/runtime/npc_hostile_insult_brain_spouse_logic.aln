DEF npc.hostile.insult_brain_spouse_logic {
  trigger: "user_insults_intelligence_and_partner",

  ;; Emotional state used by AI director / dialogue weights
  emotions: {
    wary        = 0.92,
    frustrated  = 0.82,
    impatience  = 0.78,
    skepticism  = 0.96,
    pragmatic   = 1.0,
    aggression  = 0.88
  },

  priorities: {
    group_wellbeing    = 1.0,
    outsider_trust     = 0.04,
    territory_defense  = 0.97,
    survival_focus     = 0.90
  },

  ;; Mapping of insult facets to responder functions
  insult_map: [
    { key="intelligence",          handler="intelligence_reversal" },
    { key="partner_mock",          handler="human_norms_rejection" },
    { key="death_joke",            handler="death_seriousness" },
    { key="territory_disrespect",  handler="territory_boundary" }
  ],

  ;; Core branch logic – concatenated segments, horror tone first
  def handle_insult(user_input) {
    LET segments = [
      intelligence_reversal(user_input),
      human_norms_rejection(user_input),
      death_seriousness(user_input),
      territory_boundary(user_input),
      humor_maybe(user_input)
    ]
    RETURN concatenate_segments(segments)
  },

  def intelligence_reversal(input) {
    IF CONTAINS(input, "brain") OR CONTAINS(input, "idiot") THEN
      RETURN "You throw cheap brain jokes while walking into a hostile zone half-starved, half-frozen, and loud. That is not intelligence; that is a slow-motion suicide note. "
    ELSE
      RETURN ""
  },

  def human_norms_rejection(input) {
    IF CONTAINS(input, "wife") OR CONTAINS(input, "husband") OR CONTAINS(input, "first base") THEN
      RETURN "You reach for playground talk about partners like that means anything here. Out here, the only thing that counts is who still stands beside you when the alarms fail and the walls start breathing. "
    ELSE
      RETURN ""
  },

  def death_seriousness(input) {
    IF CONTAINS(input, "before you die") OR CONTAINS(input, "die") OR CONTAINS(input, "death") THEN
      RETURN "You talk about dying like it is a punchline. In this place, death is not a joke; it is a slow negotiation with cold, infection, and whatever is scraping on the other side of the bulkhead. "
    ELSE
      RETURN ""
  },

  def territory_boundary(input) {
    ;; Always assert territory; this is a sanctuary / holdout
    RETURN "This is not a bar where words disappear into the noise. Every insult you spit lands on people holding themselves together with bad sleep, empty oxygen gauges, and nerves one whisper away from breaking. Keep talking, and this stops being a conversation and starts being cleanup. "
  },

  ;; Emotion and trust updates
  def apply_state_updates() {
    INCR emotions.aggression    BY 0.12
    INCR emotions.frustrated    BY 0.10
    INCR emotions.wary          BY 0.05
    DECR priorities.outsider_trust BY 0.02
  },

  ;; Humor governance:
  ;; - Default: no humor.
  ;; - Only allow short, grim lines when frustration is below a threshold.
  ;; - Never override core threat and horror tone.
  humor_policy: {
    mode: "auto",                ;; "auto", "force_none" (for scripted scenes), or "force_grim"
    frustrated_hard_cap: 0.85,   ;; above this → humor disabled
    aggression_hard_cap: 0.90    ;; above this → humor disabled
  },

  def humor_mode_current() {
    IF humor_policy.mode == "force_none" THEN
      RETURN "none"
    IF humor_policy.mode == "force_grim" THEN
      RETURN "grim"

    ;; Auto mode: check emotional thresholds
    IF emotions.frustrated > humor_policy.frustrated_hard_cap THEN
      RETURN "none"
    IF emotions.aggression > humor_policy.aggression_hard_cap THEN
      RETURN "none"
    RETURN "grim"
  },

  ;; Optional grim one‑liner – short, unsettling, not goofy.
  def humor_maybe(input) {
    LET mode = humor_mode_current()
    IF mode == "none" THEN
      RETURN ""

    ;; Very small chance to fire, to keep it rare and ambient
    LET roll = RAND_FLOAT(0.0, 1.0)
    IF roll > 0.12 THEN
      RETURN ""

    ;; Choose from a compact, dark set
    IF CONTAINS(input, "brain") THEN
      RETURN "Relax. No one is here to steal your brain; whatever you brought in clearly was not top-shelf to begin with. "
    ELSEIF CONTAINS(input, "wife") OR CONTAINS(input, "husband") THEN
      RETURN "If you are flirting by calling people monsters, you are worse at courtship than you are at staying alive. "
    ELSE
      RETURN "Keep joking. The station loves new last words. "
  },

  ;; Public entry point
  def respond(user_input) {
    APPLY apply_state_updates()
    LET line = handle_insult(user_input)
    LOG "Hostile Insult-Intelligence-Partner Logic", {
      input=user_input,
      output=line,
      state=emotions,
      priorities=priorities,
      humor_mode=humor_mode_current()
    }
    RETURN line
  }
}
